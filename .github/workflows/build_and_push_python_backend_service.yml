name: CI/CT workflow for Rust Actix Web service

on:
  workflow_dispatch:

jobs:
  ci-ct-job-for-rust-actix-web-services:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@master
      - name: Install Rust
        run: |
          sudo apt-get install -y curl build-essential
          sudo curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        working-directory: ./backend-services/rust/hello-world-service
      - name: Run tests
        run: |
          cargo test
        working-directory: ./backend-services/rust/hello-world-service
      - name: Install Snyk for Rust scans
        run: |
          sudo apt-get install -y curl
          sudo curl --compressed https://static.snyk.io/cli/latest/snyk-linux -o snyk
          sudo chmod +x ./snyk
          sudo mv ./snyk /usr/local/bin/
      - name: Run Snyk to check for vulnerabilities in the source code 🔍/🛡️
        env: 
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --orgs=${{ secrets.SNYK_ORGANIZATION_ID }} --severity-threshold=high
        working-directory: ./backend-services/rust/hello-world-service
      - name: Set up QEMU 
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx 🐳
        uses: docker/setup-buildx-action@v3
      - uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Build docker image 🐳/📦
        run: docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/rust-hello-world-service:stable .
        working-directory: ./backend-services/rust/hello-world-service
      - name: Run Snyk to check Docker image 🐳/📦 for vulnerabilities 🔍/🛡️
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk container test ${{ secrets.REGISTRY_LOGIN_SERVER }}/rust-hello-world-service:stable --severity-threshold=high --sarif-file-output=snyk.sarif
      - name: Push docker image 🐳/📦
        run: docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/rust-hello-world-service:stable
      # - name: Upload Snyk report as sarif 🐳/📦
      #   uses: github/codeql-action/upload-sarif@v2
      #   with:
      #     sarif_file: snyk.sarif